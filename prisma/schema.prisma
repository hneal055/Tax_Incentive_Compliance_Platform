generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Jurisdiction {
  id             String          @id @default(uuid())
  name           String
  code           String          @unique
  country        String
  type           String
  description    String? 
  website        String?
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  incentiveRules IncentiveRule[]
  productions    Production[]

  @@map("jurisdictions")
}

model IncentiveRule {
  id               String       @id @default(uuid())
  jurisdictionId   String
  jurisdiction     Jurisdiction @relation(fields:  [jurisdictionId], references: [id], onDelete: Cascade)
  ruleName         String
  ruleCode         String       @unique
  incentiveType    String
  percentage       Float? 
  fixedAmount      Float?
  minSpend         Float?
  maxCredit        Float?
  eligibleExpenses String[]
  excludedExpenses String[]
  effectiveDate    DateTime
  expirationDate   DateTime?
  requirements     String? 
  active           Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([jurisdictionId])
  @@map("incentive_rules")
}

model Production {
  id                String       @id @default(uuid())
  title             String
  productionType    String
  jurisdictionId    String
  jurisdiction      Jurisdiction @relation(fields: [jurisdictionId], references: [id])
  budgetTotal       Float
  budgetQualifying  Float?
  startDate         DateTime
  endDate           DateTime?
  productionCompany String
  status            String
  contact           String? 
  metadata          String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  expenses          Expense[]

  @@index([jurisdictionId])
  @@index([status])
  @@map("productions")
}

model Expense {
  id             String     @id @default(uuid())
  productionId   String
  production     Production @relation(fields:  [productionId], references: [id], onDelete: Cascade)
  category       String
  subcategory    String?
  description    String
  amount         Float
  expenseDate    DateTime
  paymentDate    DateTime?
  isQualifying   Boolean    @default(true)
  qualifyingNote String?
  vendorName     String?
  vendorLocation String?
  receiptNumber  String?
  invoiceNumber  String? 
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([productionId])
  @@index([expenseDate])
  @@map("expenses")
}

model Budget {
  id                  String   @id @default(uuid())
  projectTitle        String
  productionType      String
  totalBudget         Float
  startDate           DateTime
  endDate             DateTime
  productionCompany   String
  primaryJurisdiction String
  jurisdictions       String[]
  status              String   @default("active")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  accounts         BudgetAccount[]
  analyses         IncentiveAnalysis[]
  complianceChecks ComplianceCheck[]
  syncLogs         SyncLog[]

  @@index([primaryJurisdiction])
  @@index([createdAt])
  @@map("budgets")
}

model BudgetAccount {
  id                    String  @id @default(uuid())
  budgetId              String
  accountNumber         String
  category              String
  subcategory           String?
  description           String
  amount                Float
  eligibleForIncentives Boolean @default(true)
  notes                 String?

  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
  @@index([category])
  @@map("budget_accounts")
}

model IncentiveAnalysis {
  id                    String   @id @default(uuid())
  budgetId              String
  analysisDate          DateTime @default(now())
  totalEstimatedBenefit Float    @default(0)
  status                String   @default("processing")

  budget   Budget             @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  programs IncentiveProgram[]

  @@index([budgetId])
  @@index([analysisDate])
  @@map("incentive_analyses")
}

model IncentiveProgram {
  id                String @id @default(uuid())
  analysisId        String
  jurisdiction      String
  programName       String
  eligibleSpend     Float
  creditRate        Float
  estimatedBenefit  Float
  eligibilityStatus String
  requirements      String[]
  deadlines         Json?

  analysis IncentiveAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([analysisId])
  @@index([jurisdiction])
  @@map("incentive_programs")
}

model ComplianceCheck {
  id            String   @id @default(uuid())
  budgetId      String
  checkDate     DateTime @default(now())
  overallStatus String
  details       Json?

  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
  @@index([checkDate])
  @@map("compliance_checks")
}

model SyncLog {
  id        String   @id @default(uuid())
  budgetId  String
  syncDate  DateTime @default(now())
  source    String
  syncType  String
  status    String
  conflicts Json?

  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
  @@index([syncDate])
  @@map("sync_logs")
}

model WebhookRegistration {
  id        String   @id @default(uuid())
  url       String
  events    String[]
  secret    String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("webhook_registrations")
}