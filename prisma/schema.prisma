// PilotForge â€“ Production + Monitoring + Multiâ€‘Tenancy
generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1. TENANCY & AUTHENTICATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     Membership[]
  productions Production[]
  expenses    Expense[]
  apiKeys     ApiKey[]
  // Add other tenantâ€‘owned models here (e.g. Calculation, Report, etc.)
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  // Add password hash, etc. if needed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
}

model Membership {
  id             String       @id @default(uuid())
  role           Role         @default(MEMBER)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([userId, organizationId])
}

enum Role {
  ADMIN
  MEMBER
}

model ApiKey {
  id             String       @id @default(uuid())
  key            String       @unique // hashed value
  prefix         String       // First 8 chars of original key (for display)
  name           String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  permissions    String[]     @default(["read", "write"]) // Scoped permissions: read, write, admin
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  auditLogs      AuditLog[]
  usageRecords   ApiKeyUsage[]

  @@index([organizationId])
  @@index([key])
  @@map("api_keys")
}

model AuditLog {
  id             String    @id @default(uuid())
  apiKeyId       String?
  apiKey         ApiKey?   @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)
  organizationId String
  action         String    // create, delete, rotate, revoke, update
  actorId        String?   // User ID who performed the action
  metadata       String?   // JSON string with additional details
  ipAddress      String?
  userAgent      String?
  timestamp      DateTime  @default(now())

  @@index([apiKeyId])
  @@index([organizationId])
  @@index([timestamp])
  @@map("audit_logs")
}

model ApiKeyUsage {
  id             String    @id @default(uuid())
  apiKeyId       String
  apiKey         ApiKey    @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  endpoint       String
  method         String
  statusCode     Int
  responseTime   Int       // milliseconds
  timestamp      DateTime  @default(now())

  @@index([apiKeyId])
  @@index([timestamp])
  @@map("api_key_usage")
}

model WebhookConfig {
  id             String    @id @default(uuid())
  organizationId String
  url            String
  events         String[]  // api_key_expiring, api_key_expired, api_key_created, api_key_revoked
  secret         String?   // For webhook signature verification
  active         Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([organizationId])
  @@map("webhook_configs")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2. GLOBAL TAX INCENTIVE DATA (UNCHANGED, NO TENANCY)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Jurisdiction {
  id               String             @id @default(uuid())
  name             String
  code             String             @unique
  country          String
  type             String
  description      String?
  website          String?
  active           Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  incentiveRules   IncentiveRule[]
  productions      Production[]
  monitoringSources MonitoringSource[]
  monitoringEvents MonitoringEvent[]
}

model IncentiveRule {
  id               String       @id @default(uuid())
  jurisdictionId   String
  jurisdiction     Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  ruleName         String
  ruleCode         String       @unique
  incentiveType    String
  percentage       Float?
  fixedAmount      Float?
  minSpend         Float?
  maxCredit        Float?
  eligibleExpenses String[]
  excludedExpenses String[]
  effectiveDate    DateTime
  expirationDate   DateTime?
  requirements     String?
  active           Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([jurisdictionId])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 3. USERâ€‘OWNED, TENANTâ€‘SCOPED DATA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Production {
  id                String       @id @default(uuid())
  // ðŸ‘‡ NEW: tenancy field
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  title             String
  productionType    String
  jurisdictionId    String
  jurisdiction      Jurisdiction @relation(fields: [jurisdictionId], references: [id])
  budgetTotal       Float
  budgetQualifying  Float?
  startDate         DateTime
  endDate           DateTime?
  productionCompany String
  status            String
  contact           String?
  metadata          String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  expenses          Expense[]

  @@index([organizationId])
  @@index([jurisdictionId])
  @@index([status])
}

model Expense {
  id             String     @id @default(uuid())
  // ðŸ‘‡ NEW: tenancy field (optional, but simplifies direct scoping)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  productionId   String
  production     Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  category       String
  subcategory    String?
  description    String
  amount         Float
  expenseDate    DateTime
  paymentDate    DateTime?
  isQualifying   Boolean    @default(true)
  qualifyingNote String?
  vendorName     String?
  vendorLocation String?
  receiptNumber  String?
  invoiceNumber  String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([organizationId])
  @@index([productionId])
  @@index([expenseDate])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 4. MONITORING SYSTEM (GLOBAL â€“ NO TENANCY)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model MonitoringSource {
  id             String            @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction      @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  sourceType     String
  url            String
  checkInterval  Int               @default(3600)
  lastCheckedAt  DateTime?
  lastHash       String?
  active         Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  events         MonitoringEvent[]
}

model MonitoringEvent {
  id             String           @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction     @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  sourceId       String?
  source         MonitoringSource? @relation(fields: [sourceId], references: [id], onDelete: SetNull)
  eventType      String
  severity       String
  title          String
  summary        String
  sourceUrl      String?
  detectedAt     DateTime         @default(now())
  readAt         DateTime?
  metadata       String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

