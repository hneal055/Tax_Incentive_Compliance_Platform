generator client {
  provider = "prisma-client-py"
  # Note: output path removed to use default location (site-packages/prisma)
  # This allows the client to work in both venv and user installation scenarios
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Jurisdiction {
  id               String             @id @default(uuid())
  name             String
  code             String             @unique
  country          String
  type             String
  description      String? 
  website          String?
  active           Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  incentiveRules   IncentiveRule[]
  productions      Production[]
  monitoringSources MonitoringSource[]
  monitoringEvents MonitoringEvent[]

  @@map("jurisdictions")
}

model IncentiveRule {
  id               String       @id @default(uuid())
  jurisdictionId   String
  jurisdiction     Jurisdiction @relation(fields:  [jurisdictionId], references: [id], onDelete: Cascade)
  ruleName         String
  ruleCode         String       @unique
  incentiveType    String
  percentage       Float? 
  fixedAmount      Float?
  minSpend         Float?
  maxCredit        Float?
  eligibleExpenses String[]
  excludedExpenses String[]
  effectiveDate    DateTime
  expirationDate   DateTime?
  requirements     String? 
  active           Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([jurisdictionId])
  @@map("incentive_rules")
}

model Production {
  id                String       @id @default(uuid())
  title             String
  productionType    String
  jurisdictionId    String
  jurisdiction      Jurisdiction @relation(fields: [jurisdictionId], references: [id])
  budgetTotal       Float
  budgetQualifying  Float?
  startDate         DateTime
  endDate           DateTime?
  productionCompany String
  status            String
  contact           String? 
  metadata          String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  expenses          Expense[]

  @@index([jurisdictionId])
  @@index([status])
  @@map("productions")
}

model Expense {
  id             String     @id @default(uuid())
  productionId   String
  production     Production @relation(fields:  [productionId], references: [id], onDelete: Cascade)
  category       String
  subcategory    String?
  description    String
  amount         Float
  expenseDate    DateTime
  paymentDate    DateTime?
  isQualifying   Boolean    @default(true)
  qualifyingNote String?
  vendorName     String?
  vendorLocation String?
  receiptNumber  String?
  invoiceNumber  String? 
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([productionId])
  @@index([expenseDate])
  @@map("expenses")
}

model MonitoringSource {
  id             String            @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction      @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  sourceType     String
  url            String
  checkInterval  Int               @default(3600)
  lastCheckedAt  DateTime?
  lastHash       String?
  active         Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  events         MonitoringEvent[]

  @@index([jurisdictionId])
  @@index([active])
  @@map("monitoring_sources")
}

model MonitoringEvent {
  id             String           @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction     @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  sourceId       String?
  source         MonitoringSource? @relation(fields: [sourceId], references: [id], onDelete: SetNull)
  eventType      String
  severity       String
  title          String
  summary        String
  sourceUrl      String?
  detectedAt     DateTime         @default(now())
  readAt         DateTime?
  metadata       String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([jurisdictionId])
  @@index([sourceId])
  @@index([eventType])
  @@index([severity])
  @@index([detectedAt])
  @@index([readAt])
  @@map("monitoring_events")
}

