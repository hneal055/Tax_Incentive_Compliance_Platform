from fastapi import APIRouter, HTTPException, Depends
from typing import List, Optional
import psycopg2
from psycopg2.extras import RealDictCursor
import os
from datetime import datetime

router = APIRouter()

# Database connection function
def get_db_connection():
    try:
        conn = psycopg2.connect(
            host="localhost",
            port=5432,
            database="tax_incentive_db",
            user="postgres",
            password="postgres",
            cursor_factory=RealDictCursor
        )
        return conn
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Database connection failed: {str(e)}")

# ========== CLIENTS ENDPOINTS ==========

@router.get("/clients", response_model=List[dict])
async def get_clients(skip: int = 0, limit: int = 100):
    """Get all clients with pagination"""
    conn = get_db_connection()
    cur = conn.cursor()
    try:
        cur.execute("SELECT * FROM clients ORDER BY id OFFSET %s LIMIT %s", (skip, limit))
        clients = cur.fetchall()
        return clients
    finally:
        cur.close()
        conn.close()

@router.get("/clients/{client_id}", response_model=dict)
async def get_client(client_id: int):
    """Get a specific client by ID"""
    conn = get_db_connection()
    cur = conn.cursor()
    try:
        cur.execute("SELECT * FROM clients WHERE id = %s", (client_id,))
        client = cur.fetchone()
        if not client:
            raise HTTPException(status_code=404, detail="Client not found")
        return client
    finally:
        cur.close()
        conn.close()

# ========== INCENTIVES ENDPOINTS ==========

@router.get("/incentives", response_model=List[dict])
async def get_incentives(
    skip: int = 0, 
    limit: int = 100,
    status: Optional[str] = None,
    client_id: Optional[int] = None
):
    """Get all incentives with optional filtering"""
    conn = get_db_connection()
    cur = conn.cursor()
    try:
        query = """
            SELECT i.*, c.name as client_name 
            FROM incentives i
            LEFT JOIN clients c ON i.client_id = c.id
            WHERE 1=1
        """
        params = []
        
        if status:
            query += " AND i.status = %s"
            params.append(status)
        
        if client_id:
            query += " AND i.client_id = %s"
            params.append(client_id)
        
        query += " ORDER BY i.id OFFSET %s LIMIT %s"
        params.extend([skip, limit])
        
        cur.execute(query, params)
        incentives = cur.fetchall()
        return incentives
    finally:
        cur.close()
        conn.close()

@router.get("/incentives/{incentive_id}", response_model=dict)
async def get_incentive(incentive_id: int):
    """Get a specific incentive by ID"""
    conn = get_db_connection()
    cur = conn.cursor()
    try:
        cur.execute("""
            SELECT i.*, c.name as client_name 
            FROM incentives i
            LEFT JOIN clients c ON i.client_id = c.id
            WHERE i.id = %s
        """, (incentive_id,))
        incentive = cur.fetchone()
        if not incentive:
            raise HTTPException(status_code=404, detail="Incentive not found")
        return incentive
    finally:
        cur.close()
        conn.close()

# ========== EXPENSES ENDPOINTS ==========

@router.get("/expenses", response_model=List[dict])
async def get_expenses(skip: int = 0, limit: int = 100):
    """Get all expenses"""
    conn = get_db_connection()
    cur = conn.cursor()
    try:
        cur.execute("""
            SELECT e.*, c.name as client_name, i.incentive_name
            FROM expenses e
            LEFT JOIN clients c ON e.client_id = c.id
            LEFT JOIN incentives i ON e.incentive_id = i.id
            ORDER BY e.date_incurred DESC OFFSET %s LIMIT %s
        """, (skip, limit))
        expenses = cur.fetchall()
        return expenses
    finally:
        cur.close()
        conn.close()

# ========== REPORTS ENDPOINTS ==========

@router.get("/reports", response_model=List[dict])
async def get_reports(skip: int = 0, limit: int = 100):
    """Get all compliance reports"""
    conn = get_db_connection()
    cur = conn.cursor()
    try:
        cur.execute("""
            SELECT r.*, c.name as client_name 
            FROM compliance_reports r
            LEFT JOIN clients c ON r.client_id = c.id
            ORDER BY r.report_date DESC OFFSET %s LIMIT %s
        """, (skip, limit))
        reports = cur.fetchall()
        return reports
    finally:
        cur.close()
        conn.close()

# ========== STATISTICS ENDPOINT ==========

@router.get("/stats")
async def get_statistics():
    """Get platform statistics"""
    conn = get_db_connection()
    cur = conn.cursor()
    try:
        # Get counts
        cur.execute("SELECT COUNT(*) as total FROM clients")
        total_clients = cur.fetchone()['total']
        
        cur.execute("SELECT COUNT(*) as total FROM incentives")
        total_incentives = cur.fetchone()['total']
        
        cur.execute("SELECT COUNT(*) as total FROM expenses")
        total_expenses = cur.fetchone()['total']
        
        cur.execute("SELECT COUNT(*) as total FROM compliance_reports")
        total_reports = cur.fetchone()['total']
        
        # Get incentive amounts
        cur.execute("""
            SELECT 
                SUM(amount) as total_amount,
                SUM(claimed_amount) as total_claimed,
                AVG(compliance_score) as avg_score
            FROM incentives i
            LEFT JOIN compliance_reports r ON i.client_id = r.client_id
        """)
        stats = cur.fetchone()
        
        return {
            "clients": total_clients,
            "incentives": total_incentives,
            "expenses": total_expenses,
            "reports": total_reports,
            "total_incentive_amount": float(stats['total_amount'] or 0),
            "total_claimed_amount": float(stats['total_claimed'] or 0),
            "average_compliance_score": float(stats['avg_score'] or 0),
            "timestamp": datetime.now().isoformat()
        }
    finally:
        cur.close()
        conn.close()

# ========== HEALTH ENDPOINT ==========

@router.get("/health")
async def health_check():
    """Health check specifically for API routes"""
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute("SELECT 1")
        cur.close()
        conn.close()
        return {
            "status": "healthy",
            "database": "connected",
            "api": "operational",
            "timestamp": datetime.now().isoformat()
        }
    except Exception as e:
        raise HTTPException(status_code=503, detail=f"Database connection failed: {str(e)}")
