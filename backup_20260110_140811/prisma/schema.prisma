// prisma/schema.prisma
// PilotForge / Tax Incentive Compliance Platform
// Postgres + prisma-client-py

generator client {
  provider = "prisma-client-py"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Jurisdiction {
  id          String   @id @default(cuid())
  name        String
  code        String
  country     String
  type        String
  description String?
  website     String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rules       IncentiveRule[]
  productions Production[]

  @@unique([code, country])
  @@index([country])
  @@index([type])
  @@map("jurisdictions")
}

model IncentiveRule {
  id               String    @id @default(cuid())
  jurisdictionId   String
  ruleName         String
  ruleCode         String    @unique
  incentiveType    String
  percentage       Float?
  fixedAmount      Float?
  minSpend         Float?
  maxCredit        Float?
  eligibleExpenses String[]
  excludedExpenses String[]
  effectiveDate    DateTime
  expirationDate   DateTime?
  // Stored as TEXT in Postgres (confirmed). Your API layer coerces JSON-string -> dict.
  requirements     String?
  active           Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  jurisdiction     Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  calculations     Calculation[]

  @@index([jurisdictionId])
  @@map("incentive_rules")
}

model Production {
  id             String   @id @default(cuid())
  jurisdictionId String?
  title          String
  code           String?  @unique
  description    String?
  startDate      DateTime?
  endDate        DateTime?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  jurisdiction   Jurisdiction? @relation(fields: [jurisdictionId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  expenses       Expense[]
  calculations   Calculation[]

  @@index([jurisdictionId])
  @@map("productions")
}

model Expense {
  id           String   @id @default(cuid())

  // SAFE additions for existing rows:
  productionId String?                      // nullable = no reset
  category     String   @default("uncategorized")
  expenseDate  DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  // Existing/typical fields (keep yours as needed)
  description  String?
  vendor       String?
  amount       Float
  currency     String   @default("USD")
  createdAt    DateTime @default(now())

  production   Production? @relation(fields: [productionId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([productionId])
  @@map("expenses")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String?
  entityId  String?
  message   String?
  meta      Json?
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([userId])
  @@index([entity])
  @@index([entityId])
  @@map("audit_logs")
}
